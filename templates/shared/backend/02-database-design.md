# データベース設計原則

## リレーショナルデータベース設計

### 正規化

#### 第1正規形（1NF）

- **原子性**: 各フィールドは分割不可能な値
- **重複排除**: 同じテーブル内に重複行なし

#### 第2正規形（2NF）

- **完全関数従属**: 非キー属性は主キー全体に従属
- **部分従属の排除**: 主キーの一部のみに依存する属性を分離

#### 第3正規形（3NF）

- **推移従属の排除**: 非キー属性間の依存関係を分離
- **間接的依存の解消**: A→B→C の関係を直接化

### エンティティ設計

#### 主キー設計

- **自然キー vs 代理キー**: 業務的意味 vs システム生成ID
- **UUID vs AUTO_INCREMENT**: 分散システム対応 vs パフォーマンス
- **複合キー**: 多対多関係での適切な使用

#### 外部キー制約

- **参照整合性**: 関連データの一貫性保証
- **CASCADE設定**: 削除時の連鎖処理方針
- **制約命名**: 明確な制約名付け

### インデックス戦略

#### インデックス種類

- **B-Tree**: 一般的な検索・範囲検索
- **Hash**: 等価検索の高速化
- **Bitmap**: カーディナリティの低いカラム
- **Partial**: 条件付きインデックス

#### 設計指針

- **カーディナリティ**: 選択性の高いカラムを優先
- **複合インデックス**: 検索条件とソート順序を考慮
- **被覆インデックス**: 必要なカラムをすべて含める

## NoSQLデータベース設計

### ドキュメントDB（MongoDB等）

#### スキーマ設計

- **埋め込み vs 参照**: データアクセスパターンで決定
- **非正規化**: 読み取り性能優先の設計
- **配列フィールド**: 1対多関係の表現

#### インデックス戦略

- **単一フィールド**: 基本的な検索条件
- **複合インデックス**: 複数条件での検索
- **テキストインデックス**: 全文検索対応
- **地理空間インデックス**: 位置情報検索

### Key-Value Store（Redis等）

#### データ構造選択

- **String**: 単純な値・JSON文書
- **Hash**: オブジェクトの属性表現
- **List**: 順序付きコレクション
- **Set**: 重複なしコレクション
- **Sorted Set**: スコア付き順序

#### キー設計

- **命名規則**: `user:1001:profile`、`session:abc123`
- **階層化**: コロン区切りでの論理的分類
- **TTL設定**: 自動削除によるメモリ管理

## パフォーマンス最適化

### クエリ最適化

#### 実行計画分析

- **EXPLAIN**: クエリ実行計画の確認
- **コスト分析**: CPU・I/O使用量の評価
- **ボトルネック特定**: 遅い処理の原因究明

#### N+1問題対策

- **Eager Loading**: 関連データの一括取得
- **JOIN最適化**: 適切な結合戦略
- **バッチ処理**: 複数クエリの統合

### データアクセスパターン

#### 読み取り重視設計

- **非正規化**: 結合処理の削減
- **マテリアライズドビュー**: 事前計算結果の保存
- **読み取りレプリカ**: 参照専用インスタンス

#### 書き込み重視設計

- **シャーディング**: データの水平分散
- **パーティショニング**: テーブル分割戦略
- **非同期処理**: 書き込み遅延の許容

## スケーラビリティ設計

### 水平スケーリング

#### シャーディング戦略

- **範囲ベース**: 連続値での分割
- **ハッシュベース**: 均等分散優先
- **ディレクトリベース**: 柔軟なマッピング

#### 分散データ管理

- **一貫性レベル**: Strong・Eventual・Weak
- **CAP定理**: Consistency・Availability・Partition toleranceのトレードオフ
- **ACID特性**: トランザクション保証の調整

### 垂直スケーリング

#### リソース最適化

- **CPU使用量**: 計算集約的処理の分散
- **メモリ管理**: キャッシュ効率の向上
- **ストレージI/O**: ディスク使用パターンの最適化

## データ整合性・トランザクション

### ACID特性

#### Atomicity（原子性）

- **全か無か**: 処理の完全実行または完全ロールバック
- **トランザクション境界**: 適切な単位での処理
- **エラーハンドリング**: 失敗時の回復処理

#### Consistency（一貫性）

- **制約検証**: データベース制約の遵守
- **ビジネスルール**: アプリケーションレベルの整合性
- **参照整合性**: 関連データの一貫性

#### Isolation（分離性）

- **分離レベル**: READ UNCOMMITTED〜SERIALIZABLE
- **ロック戦略**: 悲観的・楽観的ロック
- **デッドロック**: 循環待機の回避・検出

#### Durability（持続性）

- **永続化**: コミット後のデータ保証
- **WAL**: Write-Ahead Logging
- **バックアップ**: データ保護戦略

### 分散トランザクション

#### 2フェーズコミット

- **準備フェーズ**: 各ノードでの準備完了確認
- **コミットフェーズ**: 全体での一括コミット
- **コーディネーター**: トランザクション管理ノード

#### Sagaパターン

- **Choreography**: 各サービスが自律的に処理
- **Orchestration**: 中央管理による制御
- **補償処理**: 失敗時のロールバック操作

## データモデル設計パターン

### 継承表現

#### Single Table Inheritance

- **利点**: シンプル・高速結合
- **欠点**: NULL値の増加・テーブル肥大化

#### Class Table Inheritance

- **利点**: 正規化・型安全性
- **欠点**: 複雑な結合・性能劣化

#### Concrete Table Inheritance

- **利点**: 型ごとの最適化
- **欠点**: 共通操作の複雑化

### 履歴管理

#### テンポラルテーブル

- **有効期間**: FROM-TO日付での履歴管理
- **バージョニング**: レコードバージョンでの追跡
- **スナップショット**: 特定時点でのデータ復元

#### イベントソーシング

- **イベントストア**: 状態変更の記録
- **プロジェクション**: 現在状態の再構築
- **リプレイ**: イベント再実行による復元

## セキュリティ設計

### アクセス制御

#### 認証

- **ユーザー管理**: アカウント・パスワード管理
- **接続暗号化**: TLS/SSL通信
- **証明書管理**: 相互認証設定

#### 認可

- **ロールベース**: 役割による権限管理
- **行レベルセキュリティ**: データ行単位での制御
- **カラムレベル暗号化**: 機密データの保護

### データ保護

#### 暗号化

- **保存時暗号化**: Encryption at Rest
- **転送時暗号化**: Encryption in Transit
- **キー管理**: 暗号鍵のライフサイクル管理

#### 監査ログ

- **アクセスログ**: データアクセス履歴
- **変更履歴**: データ変更の追跡
- **セキュリティイベント**: 不正アクセス検知

## 運用・保守設計

### バックアップ戦略

#### バックアップ種類

- **フルバックアップ**: 全データの完全コピー
- **増分バックアップ**: 変更分のみ
- **差分バックアップ**: 前回フルから変更分

#### 復旧計画

- **RTO**: Recovery Time Objective
- **RPO**: Recovery Point Objective
- **災害復旧**: 地理的冗長化

### 監視・アラート

#### パフォーマンス監視

- **レスポンス時間**: クエリ実行時間
- **スループット**: 処理件数/秒
- **リソース使用率**: CPU・メモリ・ディスク

#### 容量管理

- **ディスク使用量**: 容量枯渇の予防
- **成長予測**: 将来的な容量需要
- **アーカイブ**: 古いデータの移行

---

**言語固有の実装パターンは以下を参照：**

- [Go実装パターン](./go/)
- [TypeScript実装パターン](./typescript/)
